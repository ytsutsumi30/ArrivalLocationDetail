<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=9">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- UserControl.js library -->
    <script type="text/javascript" src="../$app/scripts/UserControl.js"></script>
    
    <!-- Tailwind CSS CDN for responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!--Cookie test-->
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            background-color: #f5f5f5;
        }
        
        /* iPadå¯¾å¿œã®ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .header-info {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .action-buttons .button-group {
                display: flex;
                gap: 12px;
            }
            .main-content {
                padding-bottom: 80px;
            }
        }
        
        @media (min-width: 768px) {
            .header-info {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .header-info {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .page-title {
            color: #374151;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 32px;
            text-align: left;
            padding: 16px 0;
            border-bottom: 3px solid #3b82f6;
        }
        
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .header-info {
            display: grid;
            gap: 20px;
        }
        
        .info-item {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        
        .info-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .info-label {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }
        
        .status-pending {
            color: #dc2626;
            background: #fef2f2;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid #fecaca;
            display: inline-block;
        }
        
        .status-completed {
            color: #059669;
            background: #f0fdf4;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid #bbf7d0;
            display: inline-block;
        }
        
        .items-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .items-header {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 20px 24px;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .items-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .items-table th {
            background: #f8fafc;
            color: #374151;
            font-weight: 600;
            padding: 16px 12px;
            text-align: left;
            border-bottom: 2px solid #e5e7eb;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .items-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            vertical-align: middle;
        }
        
        .items-table tbody tr {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .items-table tbody tr:hover {
            background: #f8fafc;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .items-table tbody tr.selected {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
        
        .item-name {
            font-weight: 600;
            color: #1e293b;
        }
        
        .item-id {
            font-family: 'Courier New', monospace;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 4px;
            color: #475569;
        }
        
        .quantity {
            text-align: right;
            font-weight: 600;
            color: #059669;
        }
        
        .order-id {
            text-align: center;
            font-weight: 500;
            color: #6366f1;
        }
        
        .ship-order-empty {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }

        .update-or {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }

        .update-date {
            text-align: center;
            color: #9ca3af;
            font-style: italic;
        }
        
        .action-button {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            min-width: 120px;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        }
        
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        .picking-button {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .ship-order-button {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
        
        .ship-order-button:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-button {
            background: #6b7280;
            margin-right: 12px;
        }
        
        .back-button:hover {
            background: #4b5563;
        }
        
        .stats-bar {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        
        .total-quantity {
            font-weight: 600;
            color: #059669;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« -->
        <h1 class="page-title" style="font-size:14px; margin-bottom:12px; padding:8px;">ç´å…¥å ´æ‰€è©³ç´°</h1>
        
        <!-- è©³ç´°æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
        <div class="detail-card">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ± -->
            <div class="header-info">
                <div class="info-item">
                    <div class="info-label-value-row">
                        <div class="info-label">ç´å…¥å ´æ‰€</div>
                        <div class="info-value" id="DeliveryLocation">æ±äº¬å–¶æ¥­æ‰€</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label-value-row">
                        <div class="info-label">å‡ºè·äºˆå®šæ—¥</div>
                        <div class="info-value" id="ShipDate">20250911</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label-value-row">
                        <div class="info-label">ç´å…¥çŠ¶æ³</div>
                        <div class="info-value">
                            <span class="status-pending" id="DeliveryStatus">æœªæ¸ˆ</span>
                        </div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label-value-row">
                        <div class="info-label">å‡ºè·å ´æ‰€</div>
                        <div class="info-value" id="ShipLocation">ç¬¬ä¸€å€‰åº«</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å“ç›®ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="main-content">
            <div class="items-section" id="itemsSection">
                <!-- ãƒ”ãƒƒã‚­ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
                <button type="button" class="action-button picking-button" id="pickingButton" onclick="startPicking()">
                    ğŸ“¦ ãƒ”ãƒƒã‚­ãƒ³ã‚°
                </button>
                
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
                <div class="loading-overlay" id="loadingOverlay" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                
                <div class="items-header">
                    <span>å‡ºè·æŒ‡ç¤ºä¸€è¦§</span>
                    <span class="items-count" id="itemsCount">0 å“ç›®</span>
                </div>
                
                <!-- çµ±è¨ˆãƒãƒ¼ -->
                <div class="stats-bar">
                    <span>é¸æŠä¸­: <span id="selectedCount">0</span> å“ç›®</span>
                    <span class="total-quantity">åˆè¨ˆæ•°é‡: <span id="totalQuantity">0</span></span>
                </div>
                
                <div class="table-container">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>é¸æŠ</th>
                                <th>å“ç›®å</th>
                                <th>å“ç›®ID</th>
                                <th>å“ç›®æ•°</th>
                                <th>ã‚ªãƒ¼ãƒ€ç•ªå·</th>
                                <th>é€ã‚ŠçŠ¶ç•ªå·</th>
                                <th>æ›´æ–°è€…</th>
                                <th>æ›´æ–°æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody">
                            <!-- å“ç›®ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <div class="action-buttons mt-6">
                <div class="button-group">
                    <button type="button" class="action-button back-button" onclick="goBack()">
                        â† æˆ»ã‚‹
                    </button>
                    <button type="button" class="action-button ship-order-button" id="shipOrderButton" onclick="createShipOrder()">
                        ğŸš› å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // ç´å…¥å ´æ‰€è©³ç´° UserControl
        var DeliveryLocationDetail = {
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿
            currentData: {
                DeliveryLocation: 'æ±äº¬å–¶æ¥­æ‰€',
                ShipDate: '20250911',
                DeliveryStatus: 'O',
                ShipLocation: 'ç¬¬ä¸€å€‰åº«',
                Items: []
            },
            
            selectedItems: new Set(),
            
            // åˆæœŸåŒ–
            init: function() {
                console.log('Delivery Location Detail initialized');
                // ä¿®æ­£ST
                // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’ãšã‚‰ã™
                setTimeout(() => {
                    console.log('Executing after 200ms delay...');
                    this.loadData();
                    this.bindEvents();
                }, 200); 
                // ä¿®æ­£ED
            },
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadData: function() {
                this.showLoading(true);
                
                // CSIã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                // this.callCSI('GetLocationDetail', [], function(result) {
                //     if (result && result.success) {
                //         DeliveryLocationDetail.currentData = result.data;
                //         DeliveryLocationDetail.displayData(result.data);
                //     } else {
                //         // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                //         DeliveryLocationDetail.loadMockData();
                //     }
                //     DeliveryLocationDetail.showLoading(false);
                // });
                
                // ä¿®æ­£ST
                //åˆæœŸãƒ‡ãƒ¼ã‚¿
                if (typeof WSForm !== 'undefined') {
                    WSForm.getVarValue('vJSONResult',function(JSONResult){ 
                        const data = JSON.parse(JSONResult);
                        DeliveryLocationDetail.displayData(data); 
                    });
                    DeliveryLocationDetail.showLoading(false);
                }

                // ä¿®æ­£ED
            },
            
            // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadMockData: function() {
                var mockData = {
                    DeliveryLocation: 'æ±äº¬å–¶æ¥­æ‰€',
                    ShipDate: '20250925',
                    DeliveryStatus: 'O',
                    ShipLocation: 'ç¬¬ä¸€å€‰åº«',
                    Items: [
                        {
                            CoLine: 1,
                            Item: 'A01',
                            Description: 'ãƒ‘ãƒãƒ«1',
                            QtyOrderedConv: 100,
                            CoNum: 1,
                            sShipOrderID: '',
                            ue_Uf_update_time_from_mongoose: '20250911 13:13:00.000'

                        },
                        {
                            CoLine: 2,
                            Item: 'A02',
                            Description: 'ãƒ‘ãƒãƒ«2',
                            QtyOrderedConv: 200,
                            CoNum: 2,
                            sShipOrderID: '',
                            ue_Uf_update_time_from_mongoose: '20250911 13:13:00.000'
                        },
                        {
                            CoLine: 3,
                            Item: 'A03',
                            Description: 'ãƒ‘ãƒãƒ«3',
                            QtyOrderedConv: 300,
                            CoNum: 3,
                            sShipOrderID: ''
                        }
                    ]
                };
                
                this.currentData = mockData;
                this.displayData(mockData);
            },
            
            // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
            displayData: function(data) {
                // ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±æ›´æ–°
                document.getElementById('DeliveryLocation').textContent = data.DeliveryLocation;
                document.getElementById('ShipDate').textContent = formatDate(data.ShipDate,'/');
                document.getElementById('ShipLocation').textContent = data.ShipLocation;
                
                var statusElement = document.getElementById('DeliveryStatus');
                statusElement.textContent = this.getStatusText(data.DeliveryStatus);
                statusElement.className = this.getStatusClass(data.DeliveryStatus);
                
                // å“ç›®ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
                this.displayItems(data.Items);
                
                // çµ±è¨ˆæƒ…å ±æ›´æ–°
                this.updateStats();
            },
            
            // å“ç›®ä¸€è¦§è¡¨ç¤º
            displayItems: function(items) {
                var tableBody = document.getElementById('itemsTableBody');
                tableBody.innerHTML = '';
                
                document.getElementById('itemsCount').textContent = items.length + ' å“ç›®';
                
                items.forEach(function(item, index) {
                    var row = document.createElement('tr');
                    row.onclick = function() {
                        DeliveryLocationDetail.toggleItemSelection(item, row);
                    };

                    // ä¿®æ­£ST
                    // JSONã®é …ç›®åã«åˆã‚ã›ã¦IDåã‚’ä¿®æ­£
                    row.innerHTML = `
                        <td>
                            <input type="checkbox" id="check_${item.CoLine}" onchange="DeliveryLocationDetail.handleCheckboxChange('${item.CoLine}', this)">
                        </td>
                        <td><span class="item-name">${item.Description}</span></td>
                        <td><span class="item-id">${item.Item}</span></td>
                        <td><span class="quantity">${Number.parseFloat(item.QtyOrderedConv).toLocaleString()}</span></td>
                        <td><span class="order-id">${item.CoNum}</span></td>
                        <td><span class="ship-order-empty">${item.sShipOrderID || '-'}</span></td>
                        <td><span class="update-or">${item.ue_Uf_updator_from_mongoose || '-'}</span></td>
                        <td><span class="update-date">${formatDate((item.ue_Uf_update_time_from_mongoose || '-'),"/")}</span></td>
                        
                        <td hidden><span class="update-date">${item.CoRelease}</span></td>
                        <td hidden><span class="update-date">${item.RecordDate}</span></td>
                        <td hidden><span class="update-date">${item.RowPointer}</span></td>
                        <td hidden><span class="update-date">${item._ItemId}</span></td>
                    `;
                    // ä¿®æ­£ED
                    
                    tableBody.appendChild(row);
                });
                
                this.currentData.items = items;
            },
            
            // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠåˆ‡ã‚Šæ›¿ãˆ
            toggleItemSelection: function(item, row) {
                var checkbox = document.getElementById('check_' + item.CoLine);
                checkbox.checked = !checkbox.checked;
                this.handleCheckboxChange(item.CoLine, checkbox);

                // ä¿®æ­£ST
                // ãƒ”ãƒƒã‚­ãƒ³ã‚°é·ç§»ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨˜éŒ²
                WSForm.setVarValue('gItem', item.Item);
                WSForm.setVarValue('gDescription', item.Description);
                WSForm.setVarValue('gQtyOrderedConv', item.QtyOrderedConv);
                // ä¿®æ­£ED
            },
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´å‡¦ç†
            handleCheckboxChange: function(itemId, checkbox) {
                var row = checkbox.closest('tr');
                
                if (checkbox.checked) {
                    this.selectedItems.add(itemId);
                    row.classList.add('selected');
                } else {
                    this.selectedItems.delete(itemId);
                    row.classList.remove('selected');
                }
                
                this.updateStats();
                this.notifySelectionChange();
            },
            
            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            updateStats: function() {
                var selectedCount = this.selectedItems.size;
                var totalQuantity = 0;
                
                this.currentData.items.forEach(function(item) {
                    if (DeliveryLocationDetail.selectedItems.has(item.CoLine)) {
                        totalQuantity += Number.parseFloat(item.QtyOrderedConv);
                    }
                });
                
                document.getElementById('selectedCount').textContent = selectedCount;
                document.getElementById('totalQuantity').textContent = totalQuantity.toLocaleString();
                
                // å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                var shipButton = document.getElementById('shipOrderButton');
                shipButton.disabled = selectedCount === 0;
                shipButton.style.opacity = selectedCount === 0 ? '0.5' : '1';
            },
            
            // é¸æŠå¤‰æ›´ã‚’CSIã«é€šçŸ¥
            notifySelectionChange: function() {
                if (typeof WSForm !== 'undefined') {
                    var selectedItems = Array.from(this.selectedItems);
                    WSForm.setVarValue('SelectedItemIds', JSON.stringify(selectedItems));
                    WSForm.setVarValue('SelectedItemCount', selectedItems.length);
                    
                    // é¸æŠå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆç”Ÿæˆ
                    WSForm.generate('ItemSelectionChanged', function(result) {
                        console.log('Selection change event:', result);
                    });
                }
            },
            
            // ãƒ”ãƒƒã‚­ãƒ³ã‚°é–‹å§‹
            startPicking: function() {
                if (this.selectedItems.size === 0) {
                    alert('ãƒ”ãƒƒã‚­ãƒ³ã‚°ã™ã‚‹å“ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                this.showLoading(true);
                
                var selectedIds = Array.from(this.selectedItems);
            
                if (typeof WSForm !== 'undefined') {
                    // ä¿®æ­£ST
                    // ãƒ”ãƒƒã‚­ãƒ³ã‚°ç”»é¢ã‚’é–‹ããƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
                    WSForm.generate('LinkToPicking');
                    // ä¿®æ­£ED
                }else{
                    // CSIãƒ”ãƒƒã‚­ãƒ³ã‚°å‡¦ç†å‘¼ã³å‡ºã—
                    this.callCSI('StartPicking', [selectedIds], function(result) {
                        DeliveryLocationDetail.showLoading(false);
                    
                        if (result && result.success) {
                            alert('ãƒ”ãƒƒã‚­ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚');
                        
                            // ãƒ”ãƒƒã‚­ãƒ³ã‚°ç”»é¢ã¸é·ç§»
                            if (typeof WSForm !== 'undefined') {
                                WSForm.invoke('OpenPickingScreen', [selectedIds], function(navResult) {
                                    console.log('Navigation to picking screen:', navResult);
                                });
                            }
                        } else {
                            alert('ãƒ”ãƒƒã‚­ãƒ³ã‚°é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'Unknown error'));
                        }
                    });
                }
                DeliveryLocationDetail.showLoading(false);
            },
            
            // å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆ
            createShipOrder: function() {
                if (this.selectedItems.size === 0) {
                    alert('å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹å“ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                this.showLoading(true);
                
                var selectedItems = this.currentData.items.filter(function(item) {
                    return DeliveryLocationDetail.selectedItems.has(item.CoLine);
                });
                
                var orderData = {
                    deliveryLocation: this.currentData.deliveryLocation,
                    shipLocation: this.currentData.shipLocation,
                    shipDate: this.currentData.shipDate,
                    items: selectedItems
                };
                
                // CSIå‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆå‡¦ç†
                // this.callCSI('CreateShipOrder', [orderData], function(result) {
                //     DeliveryLocationDetail.showLoading(false);
                    
                //     if (result && result.success) {
                //         alert('å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\nã‚ªãƒ¼ãƒ€ãƒ¼ç•ªå·: ' + (result.orderNumber || 'N/A'));
                        
                //         // ãƒ‡ãƒ¼ã‚¿å†èª­ã¿è¾¼ã¿
                //         DeliveryLocationDetail.loadData();
                        
                //         // é¸æŠã‚¯ãƒªã‚¢
                //         DeliveryLocationDetail.selectedItems.clear();
                //         DeliveryLocationDetail.updateStats();
                //     } else {
                //         alert('å‡ºè·ã‚ªãƒ¼ãƒ€ãƒ¼ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (result.message || 'Unknown error'));
                //     }
                // });

                // ä¿®æ­£ST
                // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‹ã‚­ãƒ¼ã‚’è¨­å®š
                selectedItems.forEach(function(item, index) {            
                    WSForm.setVarValue('selectCoNum', item.CoNum);
                    WSForm.setVarValue('selectCoLine', item.CoLine);
                    WSForm.setVarValue('selectCoRelease', item.CoRelease);
                    WSForm.setVarValue('selectRecordDate', item.RecordDate);
                    WSForm.setVarValue('selectRowPointer', item.RowPointer);
                    WSForm.setVarValue('selectItemId', item._ItemId);
                
                    // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
                    WSForm.generate('UpdateShipOrder');
                });
                
                DeliveryLocationDetail.showLoading(false);

                // æ›´æ–°å¾Œãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
                WSForm.generate('StdFormPredisplay');
                location.reload();
                // ä¿®æ­£ED
            },
            
            // æˆ»ã‚‹
            goBack: function() {
                if (typeof WSForm !== 'undefined') {
                    // ä¿®æ­£ST
                    // æ¤œç´¢ç”»é¢ã‚’é–‹ããƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—
                    WSForm.generate('ReturnToSearch');
                    // ä¿®æ­£ED
                } else {
                    // ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        window.close();
                    }
                }
            },
            
            // CSI APIå‘¼ã³å‡ºã—
            callCSI: function(method, params, callback) {
                if (typeof WSForm !== 'undefined') {
                    WSForm.invoke.apply(window, [].concat(method, params, callback));
                } else {
                    // é–‹ç™ºç”¨ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹
                    setTimeout(function() {
                        if (method === 'StartPicking' || method === 'CreateShipOrder') {
                            callback({
                                success: true,
                                orderNumber: 'SO' + Date.now()
                            });
                        } else {
                            callback({ success: false });
                        }
                    }, 1000);
                }
            },
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒ©ã‚¹å–å¾—
            getStatusClass: function(status) {
                // ä¿®æ­£ST
                // statã®caseã‚’IDOã«åˆã‚ã›ã‚‹
                switch(status) {
                    case 'C': return 'status-completed';
                    case 'F': return 'status-completed';
                    case 'O': return 'status-pending';
                    case 'P': return 'status-pending';
                    default: return 'status-pending';
                }
                // ä¿®æ­£ED
            },
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆå–å¾—
            getStatusText: function(status) {
                // ä¿®æ­£ST
                // statã®caseã‚’IDOã«åˆã‚ã›ã‚‹
                switch(status) {
                    case 'C': return 'å®Œäº†';
                    case 'F': return 'å…¨æ•°æ¸ˆ';
                    case 'O': return 'æœªæ¸ˆ';
                    case 'P': return 'è¨ˆç”»';
                    default: return 'æœªæ¸ˆ';
                }
                // ä¿®æ­£ED
            },
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
            showLoading: function(show) {
                var overlay = document.getElementById('loadingOverlay');
                overlay.style.display = show ? 'flex' : 'none';
            },
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
            bindEvents: function() {
                // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼ˆå°†æ¥è¿½åŠ ç”¨ï¼‰
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆå°†æ¥è¿½åŠ ç”¨ï¼‰
            }
        };
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼ˆHTMLå†…ã®onclickç”¨ï¼‰
        function startPicking() {
            DeliveryLocationDetail.startPicking();
        }
        
        function createShipOrder() {
            DeliveryLocationDetail.createShipOrder();
        }
        
        function goBack() {
            DeliveryLocationDetail.goBack();
        }

        function formatDate(date, sep="") {
            var formattedDate = date;
            if(formattedDate.length >=8){
                formattedDate = date.slice(0,4) + sep + date.slice(4,6) + sep + date.slice(6,8);
            }

            return formattedDate;
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            DeliveryLocationDetail.init();
        });
        
        // CSIçµ±åˆç”¨ã®å¤–éƒ¨å‘¼ã³å‡ºã—é–¢æ•°
        if (typeof WSForm !== 'undefined') {
            // CSIã‹ã‚‰è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
            window.setLocationDetail = function(data) {
                DeliveryLocationDetail.currentData = data;
                DeliveryLocationDetail.displayData(data);
            };
            
            // CSIã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            window.clearSelection = function() {
                DeliveryLocationDetail.selectedItems.clear();
                var checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(function(cb) {
                    cb.checked = false;
                });
                var rows = document.querySelectorAll('#itemsTableBody tr');
                rows.forEach(function(row) {
                    row.classList.remove('selected');
                });
                DeliveryLocationDetail.updateStats();
            };
        }
    </script>
</body>
</html>